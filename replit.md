# Airport Carpool Application

## Overview

This is a full-stack airport carpool coordination application built with Express.js, React, and PostgreSQL. The application allows users to create and manage airport trip listings, including flight details and car-sharing status. 

**Authentication Options:**
- **OAuth Login**: Users can log in with Replit Auth (supporting Google, GitHub, X, Apple, or email/password)
- **Invitation Signup**: Users without OAuth accounts can join using invitation codes generated by existing members

Once authenticated, users can add trips with flight information, view all trips sorted by date/time, and update their car-sharing preferences (booked, looking for rides, or offering to share).

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend Architecture

**Framework & Build System**
- **React with Vite**: The frontend uses React with Vite as the build tool and development server, providing fast hot module replacement (HMR) and optimized production builds.
- **TypeScript**: Strict TypeScript configuration ensures type safety across the application.
- **Routing**: Uses Wouter for lightweight client-side routing with conditional rendering based on authentication state:
  - Unauthenticated users see landing page at `/` with options to log in via OAuth or join by invitation
  - Authenticated users have access to: `/` (home/add trip), `/add` (add trip), `/trips` (view all trips), `/admin` (administration)

**UI Framework**
- **shadcn/ui Components**: Extensive use of Radix UI primitives wrapped in a customized component library (44+ UI components in the ui folder).
- **Tailwind CSS**: Utility-first CSS framework with custom theming using CSS variables for colors, spacing, and design tokens.
- **Design System**: "New York" style variant from shadcn/ui with neutral base color and comprehensive component coverage.

**State Management**
- **TanStack Query (React Query)**: Handles server state management, caching, and synchronization. Configured with optimistic defaults (no auto-refetch, infinite stale time).
- **React Hook Form**: Manages form state with Zod schema validation for type-safe form handling.
- **Local Component State**: React hooks for UI-specific state (modals, filters, sorting).

**Data Flow Pattern**
- Form submissions use mutations that invalidate queries on success, triggering automatic refetch of trip lists.
- Centralized API request handler with error handling and credential inclusion.
- Toast notifications for user feedback on actions.

### Backend Architecture

**Server Framework**
- **Express.js**: RESTful API server with middleware for JSON parsing, URL encoding, and request logging.
- **Custom Vite Integration**: Development mode serves frontend through Vite middleware; production serves static files.

**Authentication & Authorization**
- **Dual Authentication System**:
  - **Replit Auth (OAuth)**: OpenID Connect provider supporting Google, GitHub, X, Apple, and email/password login
  - **Invitation-Based Signup**: Users can join with invitation codes generated by authenticated members
- **Session Management**: PostgreSQL-backed sessions with 7-day TTL, secure cookies (HTTPS in production)
- **Middleware**: `isAuthenticated` middleware protects trip and admin routes, validates and refreshes tokens automatically
- **Auth Routes**:
  - `GET /api/login` - Initiates OAuth flow
  - `GET /api/callback` - OAuth callback handler
  - `GET /api/logout` - Logs out and clears session
  - `GET /api/auth/user` - Returns current user or null (public endpoint)
  - `POST /api/invitations/signup` - Public endpoint for invitation-based user creation

**API Structure**
- **Trip Endpoints** (all protected, require authentication):
  - `GET /api/trips` - List all trips
  - `GET /api/trips/:id` - Get single trip
  - `POST /api/trips` - Create trip
  - `PUT /api/trips/:id` - Update trip
  - `DELETE /api/trips/:id` - Delete trip
  - `GET /api/trips/export` - Export all trips as CSV
  - `POST /api/trips/import` - Import trips from CSV (replaces all data)
- **Admin Endpoints** (protected, require authentication):
  - `GET /api/admin/users` - List all registered users
  - `GET /api/admin/invitations` - List all invitation codes
  - `POST /api/admin/invitations` - Generate new invitation code (accepts maxUses and expiresInHours)
  - `DELETE /api/admin/invitations/:id` - Revoke invitation code
  - `GET /api/admin/settings/oauth` - Get OAuth access control settings
  - `PUT /api/admin/settings/oauth` - Update OAuth access control settings

**Request/Response Handling**
- Zod schema validation on incoming requests
- Structured error responses with appropriate HTTP status codes
- Request logging middleware captures method, path, status, duration, and response preview

**Storage Abstraction**
- **IStorage Interface**: Defines contract for data operations, enabling easy switching between storage implementations.
- **MemStorage Implementation**: In-memory storage using Map for development/testing with automatic sorting by flight date/time.
- **Future Database Support**: Architecture supports swapping to database-backed storage without changing business logic.

### Data Storage Solutions

**Database Configuration**
- **Drizzle ORM**: Type-safe ORM configured for PostgreSQL with migrations in `/migrations` directory.
- **Neon Serverless**: Uses `@neondatabase/serverless` driver for PostgreSQL connectivity.
- **Schema Location**: Database schema defined in `shared/schema.ts` for type sharing between client and server.

**Data Model**
- **Users Table**: Stores user authentication data (id, email, firstName, lastName, profileImageUrl, authProvider)
  - `authProvider`: Distinguishes between "oidc" (OAuth) and "invitation" (invitation-based) users
- **Sessions Table**: Stores session data for authentication with PostgreSQL connect-pg-simple
- **Invitation Codes Table**: Manages invitation codes for signup with advanced features
  - `maxUses`: Maximum number of times the code can be used (default: 1)
  - `currentUses`: Current usage count (increments on each use)
  - `expiresAt`: Optional expiration timestamp
  - Tracks code status: active, used up, expired, or revoked
  - Records who created the code and who used it
- **Settings Table**: Key-value store for application-wide settings
  - `key`: Unique identifier for the setting (e.g., "allowed_domains", "allowed_github_orgs")
  - `value`: JSON value for flexible data storage
- **Trips Table**: Single entity with fields for name, flight date/time, flight number, car status, and timestamps
- **Validation**: Drizzle-Zod integration generates Zod schemas from database schema for consistent validation
- **Type Generation**: TypeScript types inferred from schema for compile-time safety

**Migration Strategy**
- Drizzle Kit handles schema migrations with `npm run db:push` for development.
- Migration files stored in `/migrations` directory (generated but not committed to repository).

### External Dependencies

**UI Component Libraries**
- Radix UI primitives (accordion, alert-dialog, avatar, checkbox, dialog, dropdown-menu, etc.)
- Embla Carousel for carousel functionality
- cmdk for command palette interfaces
- lucide-react for icon system

**Form & Validation**
- react-hook-form for form state management
- @hookform/resolvers for validation integration
- zod for runtime type validation
- drizzle-zod for schema-to-validation bridging

**Styling & Theming**
- Tailwind CSS with PostCSS
- class-variance-authority for component variants
- clsx and tailwind-merge for conditional class composition

**Date/Time Handling**
- date-fns for date manipulation and formatting

**Development Tools**
- @replit/vite-plugin-runtime-error-modal for error overlays
- @replit/vite-plugin-cartographer for code navigation
- tsx for TypeScript execution in development

**Authentication**
- passport for authentication middleware
- passport-local for local strategy
- openid-client for OpenID Connect (Replit Auth)
- express-session for session management
- connect-pg-simple for PostgreSQL session store
- memoizee for caching OIDC configuration

**Database**
- @neondatabase/serverless for PostgreSQL connections
- drizzle-orm for ORM functionality
- drizzle-kit for migrations

**Query & State**
- @tanstack/react-query for server state management

**Build Tools**
- vite for frontend bundling
- esbuild for server bundling in production
- @vitejs/plugin-react for React support

**Utilities**
- nanoid for generating unique invitation codes

## Recent Changes (October 2025)

### OAuth Access Controls & Enhanced Invitations (October 3, 2025)
Implemented OAuth access restrictions and enhanced invitation code system:

**OAuth Access Control:**
- **Domain Validation**: Restrict Google OAuth logins to specific email domains (e.g., only @company.com)
- **GitHub Organizations**: Framework for restricting GitHub logins to organization members (full implementation pending)
- **Admin UI**: New "OAuth Settings" tab in `/admin` page for managing allowed domains and GitHub organizations
- **Settings Storage**: New database table for storing application-wide settings as key-value pairs
- **Validation**: OAuth callback checks email domain against allowed domains list before creating user session

**Enhanced Invitation Codes:**
- **Multi-Use Codes**: Invitation codes can now be reused (configurable max uses, default: 1)
- **Expiration**: Codes expire after configurable hours (default: 24 hours)
- **Usage Tracking**: Database tracks `currentUses` vs `maxUses` for each invitation code
- **Advanced Dialog**: New creation dialog with inputs for max uses and expiration hours
- **Updated Display**: Invitation table shows usage count (e.g., "2 / 5"), expiration time, and status (Active/Used Up/Expired/Revoked)
- **Validation**: Backend validates invitation codes for existence, usage limits, expiration, and revocation status

**Bug Fixes:**
- Fixed infinite render loop in Admin OAuth Settings tab (moved state updates to useEffect)
- Fixed invitation users access to trip data (added `expires_at` field to invitation user sessions)

### Invitation System (October 3, 2025)
Added invitation-based signup system for users without OAuth accounts:
- **Landing Page**: "Join by Invitation" button opens signup dialog for invitation code entry
- **Admin Page**: New `/admin` route with four tabs:
  - **Users Tab**: List all registered users with authentication method badges (OAuth vs Invitation)
  - **Invitations Tab**: Create, list, copy, and revoke invitation codes
  - **OAuth Settings Tab**: Manage allowed domains and GitHub organizations
  - **Data Tab**: CSV export/import functionality (moved from separate /data page)
- **Security**: All invitation codes validated for existence, usage status, and revocation
- **Navigation**: Header updated to show "Admin" link for authenticated users